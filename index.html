<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#1a1a1a">
<title>Tile Stock</title>

<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
        font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
        background:#1a1a1a;color:#fff;
        padding-top:env(safe-area-inset-top);
        padding-bottom:env(safe-area-inset-bottom);
    }
    .container{max-width:600px;margin:0 auto;height:100vh;display:flex;flex-direction:column}
    .search-container{padding:12px 16px;border-bottom:1px solid #333}
    .search-box{width:100%;padding:10px 15px;border:none;border-radius:8px;background:#2a2a2a;color:#fff;font-size:1rem}
    .folder-tabs{display:flex;background:#1a1a1a;border-bottom:1px solid #333}
    .folder-btn{flex:1;padding:12px;border:none;background:transparent;color:#999;cursor:pointer;font-weight:600;transition:.3s;border-bottom:2px solid transparent}
    .folder-btn:hover{color:#ddd}
    .folder-btn.active{color:#fff;border-bottom-color:#667eea}
    .stats{padding:12px 16px;text-align:center;color:#666;font-size:.85rem;border-bottom:1px solid #2a2a2a}
    .content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .pdf-list{display:flex;flex-direction:column}
    .pdf-item{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #2a2a2a;transition:.2s}
    .pdf-item:active{background:#2a2a2a}
    .pdf-size{font-weight:600;margin-bottom:6px;word-break:break-word}
    .pdf-date{color:#888;font-size:.85rem}
    .whatsapp-btn{
        padding:10px 20px;border:none;border-radius:8px;background:#25D366;color:#fff;
        font-weight:600;cursor:pointer;font-size:.95rem;white-space:nowrap;
        transition:all .25s cubic-bezier(.4,0,.2,1);outline:2px solid transparent;
    }
    .whatsapp-btn:hover{
        background:#1fb952;transform:scale(1.05);outline:2px solid #20e85f;
    }
    .whatsapp-btn:active{
        transform:scale(0.93);outline:2px solid #25D366;
    }
    .loading,.empty-state{display:flex;align-items:center;justify-content:center;height:100%;color:#667eea;font-size:1rem}
    .refresh-btn{
        position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;
        background:#667eea;color:#fff;border:none;font-size:1.5rem;cursor:pointer;
        box-shadow:0 4px 12px rgba(102,126,234,.3);transition:.2s;
    }
    .refresh-btn:active{transform:scale(.9)}
    @media(max-width:400px){
        .pdf-item{padding:12px}.pdf-size{font-size:.9rem}.whatsapp-btn{padding:8px 16px;font-size:.85rem}
    }
</style>
</head>
<body>
<div class="container">
    <div class="search-container">
        <input type="text" id="searchInput" class="search-box" placeholder="Search size...">
    </div>

    <div class="folder-tabs">
        <button class="folder-btn active" onclick="switchFolder('after-order',this)">After Order</button>
        <button class="folder-btn" onclick="switchFolder('classified',this)">Classified</button>
    </div>

    <div id="stats" class="stats" style="display:none;">üìä <span id="pdf-count">0</span> PDFs</div>

    <div class="content">
        <div id="loading" class="loading"><span class="spinner">‚è≥</span> Loading...</div>
        <div id="pdf-list" class="pdf-list" style="display:none;"></div>
        <div id="empty-state" class="empty-state" style="display:none;">No PDFs found</div>
    </div>
</div>

<button class="refresh-btn" onclick="location.reload()">üîÑ</button>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbxSRXlWhonoR_rcuMlGPZjZo9jmMHI4XkY0340ET7lTedyMBYjG1ze6Iv2MVtN1MctF/exec';
let currentFolder='after-order';
let allPDFs={'after-order':[],'classified':[]};

// ===== FETCH DATA =====
async function fetchAllPDFs(){
    try{
        const response=await fetch(API_URL);
        const data=await response.json();
        if(data.error){console.error('API Error:',data.error);return null;}
        allPDFs=data;
        return data;
    }catch(e){console.error('Fetch Error:',e);return null;}
}

// ===== FORMAT DATE =====
function formatDateTime(d){
    if(!d)return'N/A';
    try{
        const date=new Date(d);
        const dd=String(date.getDate()).padStart(2,'0');
        const mm=String(date.getMonth()+1).padStart(2,'0');
        const yy=date.getFullYear();
        const hh=String(date.getHours()).padStart(2,'0');
        const mi=String(date.getMinutes()).padStart(2,'0');
        return`${dd}/${mm}/${yy} ${hh}:${mi}`;
    }catch(e){return d;}
}

// ===== SHARE TO WHATSAPP =====
async function shareToWhatsApp(pdfUrl,sizeFolder){
    try{
        console.log('Share initiated for:',sizeFolder);
        const response=await fetch(pdfUrl);
        const blob=await response.blob();
        const file=new File([blob],`${sizeFolder}.pdf`,{type:'application/pdf'});

        // ‚úÖ Web Share API supported?
        if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
            await navigator.share({
                files:[file],
                title:'Tile Stock',
                text:`üìÑ Tile Stock: ${sizeFolder}`
            });
            console.log('Shared successfully!');
        }else{
            console.warn('Web Share API not supported ‚Äî using WhatsApp fallback');
            const msg=encodeURIComponent(`üìÑ ${sizeFolder}\n\n${pdfUrl}`);
            window.location.href=`https://wa.me/?text=${msg}`;
        }
    }catch(err){
        if(err.name!=='AbortError'){
            console.error('Share Error:',err);
            alert('Sharing not supported on this device.\nOpening WhatsApp link instead.');
            const msg=encodeURIComponent(`üìÑ ${sizeFolder}\n\n${pdfUrl}`);
            window.location.href=`https://wa.me/?text=${msg}`;
        }
    }
}

// ===== DISPLAY PDF LIST =====
function displayPDFs(data){
    const pdfList=document.getElementById('pdf-list');
    const empty=document.getElementById('empty-state');
    const load=document.getElementById('loading');
    const stats=document.getElementById('stats');
    const count=document.getElementById('pdf-count');
    load.style.display='none';

    if(!data.length){
        pdfList.style.display='none';
        empty.style.display='flex';
        stats.style.display='none';
        return;
    }
    empty.style.display='none';
    stats.style.display='block';
    count.textContent=data.length;
    pdfList.innerHTML='';
    pdfList.style.display='flex';
    data.sort((a,b)=>a.sizeFolder.localeCompare(b.sizeFolder));

    data.forEach(pdf=>{
        const item=document.createElement('div');
        item.className='pdf-item';
        const info=document.createElement('div');
        info.innerHTML=`<div class="pdf-size">${pdf.sizeFolder}</div><div class="pdf-date">${formatDateTime(pdf.date)}</div>`;
        const btn=document.createElement('button');
        btn.className='whatsapp-btn';
        btn.textContent='üì± Share';
        btn.onclick=(e)=>{
            e.preventDefault();e.stopPropagation();
            shareToWhatsApp(pdf.pdfUrl,pdf.sizeFolder);
        };
        item.append(info,btn);
        pdfList.appendChild(item);
    });
}

// ===== SWITCH FOLDER =====
function switchFolder(folder,btn){
    currentFolder=folder;
    document.querySelectorAll('.folder-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('searchInput').value='';
    const folderData=allPDFs[currentFolder]||[];
    displayPDFs(folderData);
}

// ===== SEARCH =====
function handleSearch(){
    const term=document.getElementById('searchInput').value.toLowerCase();
    const folderData=allPDFs[currentFolder]||[];
    const filtered=folderData.filter(p=>p.sizeFolder.toLowerCase().includes(term));
    displayPDFs(filtered);
}
document.getElementById('searchInput').addEventListener('input',handleSearch);

// ===== INIT =====
async function initializeApp(){
    document.getElementById('loading').style.display='flex';
    const data=await fetchAllPDFs();
    if(data){
        const folderData=data[currentFolder]||[];
        displayPDFs(folderData);
    }else{
        document.getElementById('loading').style.display='none';
        document.getElementById('empty-state').style.display='flex';
    }
}
window.addEventListener('DOMContentLoaded',initializeApp);
</script>
</body>
</html>
